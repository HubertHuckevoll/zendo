#!/bin/bash

# Configuration
CONTAINER_NAME="zendo_https"
IMAGE_NAME="zendo_https"
HOST_HTTP_PORT=80
HOST_HTTPS_PORT=443
DATASTORE_DIR="$HOME/zendo.datastore"
LETSENCRYPT_VOLUME="letsencrypt"

# Ensure data directory exists with correct permissions (UID/GID 33 for www-data)
echo "Setting permissions for $DATASTORE_DIR to www-data (UID 33, GID 33)..."
mkdir -p "$DATASTORE_DIR"
sudo chown -R 33:33 "$DATASTORE_DIR"

# Check if container is already running and stop it if necessary
if [ "$(sudo docker ps -q -f name=$CONTAINER_NAME)" ]; then
    echo "Container $CONTAINER_NAME already running. Stopping it first..."
    sudo docker stop "$CONTAINER_NAME"
fi

# Remove existing container if present
if [ "$(sudo docker ps -aq -f status=exited -f name=$CONTAINER_NAME)" ]; then
    echo "Removing existing container $CONTAINER_NAME..."
    sudo docker rm "$CONTAINER_NAME"
fi

# Build the Docker image
echo "Building Docker image $IMAGE_NAME..."
sudo docker build -t "$IMAGE_NAME" .

# Run Docker container with Let's Encrypt volume for certificate persistence
echo "Starting Docker container $CONTAINER_NAME..."
sudo docker run -d \
    --name "$CONTAINER_NAME" \
    -p "$HOST_HTTP_PORT":80 -p "$HOST_HTTPS_PORT":443 \
    -v "$DATASTORE_DIR":/var/www/html/zendo.datastore \
    -v "$LETSENCRYPT_VOLUME":/etc/letsencrypt \
    "$IMAGE_NAME"

# Wait briefly to confirm container is running
sleep 3

# Verify container status
if [ "$(sudo docker ps -q -f name=$CONTAINER_NAME)" ]; then
    echo "Container '$CONTAINER_NAME' started successfully."
    echo "Your application is now accessible at:"
    echo "   HTTP:  http://localhost/"
    echo "   HTTPS: https://meyerk.de/"
else
    echo "Failed to start container '$CONTAINER_NAME'. Check logs using:"
    echo "   sudo docker logs $CONTAINER_NAME"
    exit 1
fi

# Set up automatic Let's Encrypt certificate renewal via Docker exec cron job
echo "Setting up automatic Let's Encrypt certificate renewal..."
sudo docker exec "$CONTAINER_NAME" bash -c "echo '0 3 * * * root certbot renew --quiet' > /etc/cron.d/certbot-renew && cron"

echo "âœ… Automatic certificate renewal has been set up successfully."
